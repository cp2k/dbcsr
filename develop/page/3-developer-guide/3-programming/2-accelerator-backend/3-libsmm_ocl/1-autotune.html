<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="">
    <meta name="author" content="DBCSR Authors" >
    <link rel="icon" href="../../../../../favicon.png">

    <title>Autotune &ndash; DBCSR</title>

    <link href="../../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../../css/pygments.css" rel="stylesheet">
    <link href="../../../../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../../css/local.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

         <script src="../../../../../js/jquery-2.1.3.min.js"></script>
         <script src="../../../../../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../../../../index.html">DBCSR <small>2.6.0</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
              <li><a href='../../../../../page/index.html'>Guide</a></li>
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
                 data-toggle="dropdown" role="button"
                 aria-haspopup="true"
                 aria-expanded="false">
                 Contents <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                    <li><a href="../../../../../lists/files.html">Source Files</a></li>
                  <li><a href="../../../../../lists/modules.html">Modules</a></li>
                  <li><a href="../../../../../lists/procedures.html">Procedures</a></li>
                  <li><a href="../../../../../lists/absint.html">Abstract Interfaces</a></li>
                  <li><a href="../../../../../lists/types.html">Derived Types</a></li>
                  <li><a href="../../../../../lists/programs.html">Programs</a></li>
              </ul>
            </li>
                <li class="visible-xs hidden-sm visible-lg">
                  <a href="../../../../../lists/files.html">Source Files</a>
                </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/modules.html">Modules</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/procedures.html">Procedures</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/absint.html">Abstract Interfaces</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/types.html">Derived Types</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/programs.html">Programs</a>
              </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
  <div class="row">
    <h1>Autotune</h1>
    <div class="row">
    <div class="col-lg-12">
    <div class="well well-sm" style="min-height: 40px;">
      <ul class="list-inline" style="margin-bottom:0px; display:inline">
<!--
-->
      </ul>
        <ol class="breadcrumb in-well">
         <li><a href='../../../../../page/index.html'>Guide</a></li>
         <li><a href='../../../../../page/3-developer-guide/index.html'>Developer Guide</a></li>
         <li><a href='../../../../../page/3-developer-guide/3-programming/index.html'>Programming</a></li>
         <li><a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/index.html'>Accelerator Backend</a></li>
         <li><a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/index.html'>OpenCL</a></li>
         <li class="active">Autotune</li>
      </ol>
    </div>
    </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-9 col-md-push-3" id='text'>
      <h1>Auto Tuning</h1>
<p>Auto tuning code for performance is a practical way to find the "best" setting for parameterized code (e.g., GPU kernels). Introducing effective parameters is a prerequisite, and exploring the (potentially) high-dimensional parameter space in an efficient way is an art. It is desirable to have reasonable defaults even without auto-tuning the parameters. It would be even better to avoid auto-tuning if best performance was possible right away.</p>
<p>For the OpenCL based LIBSMM, a variety of parameters are explored using <a href="http://opentuner.org/">OpenTuner</a>. The script <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/opencl/smm/tune_multiply.py">tune_multiply.py</a> (or tune_multiply.sh) leverages the <code>acc_bench_smm</code> by parsing console output (timing, data type, etc.). This way, the tuning is implemented without being intermingled with the subject being tuned. The "communication" between the tuner and the executable is solely based on environment variables.</p>
<p><strong>NOTE</strong>: If <code>tune_multiply.py</code> (or <code>tune_multiply.sh</code>) is called with an environment variable already set, the respective parameter (e.g., <code>OPENCL_LIBSMM_SMM_BM</code> or <code>OPENCL_LIBSMM_SMM_BN</code>) is considered fixed (and not tuned automatically). This way, the parameter space is reduced in size and effort can be directed more intensely towards the remaining parameters.</p>
<p>To toggle the benchmarks between tuning single precision (SP) and double precision (DP), <code>make ELEM_TYPE=float</code> can be used when building the benchmark drivers (<code>ELEM_TYPE</code> can be also directly edited in <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/acc_bench_smm.c#L26">acc_bench_smm.c</a>). Auto-tuned parameters for SP and DP can be embedded into the same final application and are considered correctly at runtime.</p>
<p>To build the benchmarks in double precision (<code>ELEM_TYPE=double</code> is default):</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> src/acc/opencl
make
</code></pre></div>

<p>To build the benchmarks in single precision (SP):</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> src/acc/opencl
make <span class="nv">ELEM_TYPE</span><span class="o">=</span>float
</code></pre></div>

<p>To auto-tune, please install the Python <code>wheel</code> and <code>opentuner</code> packages:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> src/acc/opencl/smm
pip install -r requirements.txt
</code></pre></div>

<p>The OpenTuner script supports several command line arguments (<code>tune_multiply.py --help</code>). For example, <code>--stop-after=300</code> can be of interest to finish in five minutes (without limit, OpenTuner decides when the auto-tuning process is finished). A single kernel can be selected by M, N, and K parameters (GEMM), e.g., <code>M=15</code>, <code>N=5</code>, and <code>K=7</code>:</p>
<div class="codehilite"><pre><span></span><code>./tune_multiply.py 13x5x7
</code></pre></div>

<p><strong>NOTE</strong>: If multiple different kernels are tuned using <code>tune_multiply.py</code>, it is advisable to delete the <code>opentuner.db</code> directory prior to tuning a different kernel since otherwise auto-tuning is potentially (mis-)guided by information which was collected for a different kernel (<code>tune_multiply.sh</code> does this automatically).</p>
<p>The OpenTuner script implements multiple objectives ("cost"), primarily "accuracy" (maximized) and a secondary objective "size" (minimized). The former represents the achieved performance (GFLOPS/s) while the latter represents an artificial kernel requirement (just to prefer one parameter set over another in case of similar performance). The console output looks like ("accuracy" denotes performance in GFLOPS/s):</p>
<div class="codehilite"><pre><span></span><code>[    15s]    INFO opentuner.search.plugin.DisplayPlugin: tests=8, best {&#39;BS&#39;: 32, &#39;BM&#39;: 6, &#39;BN&#39;: 1}, cost accuracy=28.80000000, size=1.0, found by UniformGreedyMutation
[    27s]    INFO opentuner.search.plugin.DisplayPlugin: tests=19, best {&#39;BS&#39;: 48, &#39;BM&#39;: 8, &#39;BN&#39;: 1}, cost accuracy=32.20000000, size=1.0, found by UniformGreedyMutation
[    40s]    INFO opentuner.search.plugin.DisplayPlugin: tests=31, best {&#39;BS&#39;: 48, &#39;BM&#39;: 8, &#39;BN&#39;: 1}, cost accuracy=32.20000000, size=1.0, found by UniformGreedyMutation
[    54s]    INFO opentuner.search.plugin.DisplayPlugin: tests=43, best {&#39;BS&#39;: 48, &#39;BM&#39;: 8, &#39;BN&#39;: 1}, cost accuracy=32.20000000, size=1.0, found by UniformGreedyMutation
[    67s]    INFO opentuner.search.plugin.DisplayPlugin: tests=53, best {&#39;BS&#39;: 48, &#39;BM&#39;: 8, &#39;BN&#39;: 1}, cost accuracy=32.20000000, size=1.0, found by UniformGreedyMutation
</code></pre></div>

<p>The script finally writes a JSON-file with a filename like <code>tune_multiply-float-12x12x12-s15-60gflops.json</code> which is encoding the benchmark ("multiply"), the precision ("float"), the kernel ("12x12x12"), the number of bits necessary to represent the size of the problem, i.e., log2 of the problem-size ("s15"), and the achieved performance ("60gflops"). The script handles SIGINT (like Ctrl-C), and output is still written despite of abnormally terminating (can be abused to tune interactively). Tuning starts from an internal default that is supposed to match LIBSMM's internal default parameters. However, tuning can be (re-)started with specific parameters (e.g., <code>-bs 64</code>, <code>-bm 13</code>, <code>-bn 1</code> for <code>OPENCL_LIBSMM_SMM_BS</code>, <code>OPENCL_LIBSMM_SMM_BM</code>, and <code>OPENCL_LIBSMM_SMM_BN</code> respectively), or partially fixed for a subset of parameters.</p>
<p><strong>NOTE</strong>: The <code>acc_bench_smm</code> executable is potentially started many times when auto-tuning parameters, therefore it is advisable to keep the state of the GPU driver stack persistent (if the setup would otherwise unload the driver configuration), e.g., <code>nvidia-smi -pm ENABLED</code>. This can happen in cases where the GPU is only for compute and not used for graphics (no X-Window system, e.g., in case of a "headless" system). Time needed for tuning parameters is not only impacted by accessing and readying the device, but also by the time needed to compile a kernel at runtime aka Just-In-Time (JIT).</p>
    </div>
    <div class="col-md-3 col-md-pull-9">
      <hr class="visible-xs visible-sm">
        <div class="well toc">
          <ul class="nav nav-stacked nav-pills">
            <li role="presentation" class="title"><a href='../../../../../page/index.html'>Guide</a></li>
          </ul>
          <hr>
          <ul class="nav nav-stacked nav-pills">
            <li role="presentation">
            <a href='../../../../../page/1-DBCSR/index.html'>DBCSR</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/1-DBCSR/publications.html'>Publications</a>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/index.html'>User Guide</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/index.html'>Install</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/1-cmake-build-recipes.html'>CMake Build Recipes</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/2-supported-compilers.html'>Supported Compilers</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/3-using-dbcsr-in-a-cmake-project.html'>Using DBCSR in a CMake project</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/4-docker.html'>Docker Images</a>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/2-tests/index.html'>Tests</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/3-examples/index.html'>Examples</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/4-gpu/index.html'>GPUs</a>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/index.html'>Developer Guide</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/1-tooling/index.html'>Tooling</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/2-documentation/index.html'>Documentation</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/index.html'>Programming</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/1-overview/index.html'>Overview</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/index.html'>Accelerator Backend</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/1-code-structure.html'>Code Structure</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/index.html'>CUDA/HIP</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/1-kernels.html'>Kernels</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/2-parameters.html'>Kernel Parameters</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/3-tune.html'>Autotuning Framework</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/4-predict.html'>Predictive Modeling Framework</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/5-notebooks.html'>Notebooks</a>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/index.html'>OpenCL</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation" class="disabled">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/1-autotune.html'>Autotune</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/2-bulktune.html'>Parameters</a>
            </li>

            </ul>
            </li>

            </ul>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/4-performance/index.html'>Performance</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/4-performance/1-insights.html'>Insights</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/4-performance/2-just-in-time-compilation.html'>JIT</a>
            </li>

            </ul>
            </li>

            </ul>
            </li>
          </ul>
        </div>
    </div>
  </div>
      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-xs-6 col-md-6"><p>DBCSR was developed by DBCSR Authors<br>&copy; 2023 
</p>
          </div>
          <div class="col-xs-6 col-md-6">
            <p class="text-right">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript
         ================================================== -->
         <!-- Placed at the end of the document so the pages load faster -->
    <!--
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        -->
        <script src="../../../../../js/bootstrap.min.js"></script>
        <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
        <script src="../../../../../js/ie10-viewport-bug-workaround.js"></script>

        <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </body>
</html>