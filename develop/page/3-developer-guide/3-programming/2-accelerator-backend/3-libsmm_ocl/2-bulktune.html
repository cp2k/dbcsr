<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="">
    <meta name="author" content="DBCSR Authors" >
    <link rel="icon" href="../../../../../favicon.png">

    <title>Parameters &ndash; DBCSR</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../../../../../css/pygments.css" rel="stylesheet">
    <link href="../../../../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../../css/local.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha256-tG5mcZUtJsZvyKAxYLVXrmjKBVLd6VpVccqz/r4ypFE=" crossorigin="anonymous"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../../../../../index.html">DBCSR <small>2.6.0</small></a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../../../../../page/index.html">Guide</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../../lists/types.html">Derived Types</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../../lists/programs.html">Programs</a>
                </li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>Parameters</h1>
    <div class="container p-2 mb-4 bg-light border rounded-3">
      <div class="row align-items-center justify-content-between">
        <div class="col">
          <ul class="list-inline" style="margin-bottom:0px; display:inline">
          </ul>
        </div>
        <div class="col">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../../../../../page/index.html'>Guide</a></li>
                <li class="breadcrumb-item"><a href='../../../../../page/3-developer-guide/index.html'>Developer Guide</a></li>
                <li class="breadcrumb-item"><a href='../../../../../page/3-developer-guide/3-programming/index.html'>Programming</a></li>
                <li class="breadcrumb-item"><a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/index.html'>Accelerator Backend</a></li>
                <li class="breadcrumb-item"><a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/index.html'>OpenCL</a></li>
              <li class="breadcrumb-item active" aria-current="page">Parameters</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
      <div class="col-3">
        <div class="card card-body bg-light" id="sidebar-toc">
          <ul class="nav flex-column align-items">
            <li class="nav-item">
              <a class="nav-link" href="../../../../../page/index.html">Guide</a>
            </li>
          </ul>
          <hr>
          <nav class="nav nav-pills flex-column">
              <a class="nav-link" href="../../../../../page/1-DBCSR/index.html">DBCSR</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/1-DBCSR/publications.html">Publications</a>

                </nav>
              <a class="nav-link" href="../../../../../page/2-user-guide/index.html">User Guide</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/2-user-guide/1-installation/index.html">Install</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/2-user-guide/1-installation/1-cmake-build-recipes.html">CMake Build Recipes</a>
              <a class="nav-link" href="../../../../../page/2-user-guide/1-installation/2-supported-compilers.html">Supported Compilers</a>
              <a class="nav-link" href="../../../../../page/2-user-guide/1-installation/3-using-dbcsr-in-a-cmake-project.html">Using DBCSR in a CMake project</a>
              <a class="nav-link" href="../../../../../page/2-user-guide/1-installation/4-docker.html">Docker Images</a>

                </nav>
              <a class="nav-link" href="../../../../../page/2-user-guide/2-tests/index.html">Tests</a>
              <a class="nav-link" href="../../../../../page/2-user-guide/3-examples/index.html">Examples</a>
              <a class="nav-link" href="../../../../../page/2-user-guide/4-gpu/index.html">GPUs</a>

                </nav>
              <a class="nav-link" href="../../../../../page/3-developer-guide/index.html">Developer Guide</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/3-developer-guide/1-tooling/index.html">Tooling</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/2-documentation/index.html">Documentation</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/index.html">Programming</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/1-overview/index.html">Overview</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/index.html">Accelerator Backend</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/1-code-structure.html">Code Structure</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/index.html">CUDA/HIP</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/1-kernels.html">Kernels</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/2-parameters.html">Kernel Parameters</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/3-tune.html">Autotuning Framework</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/4-predict.html">Predictive Modeling Framework</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/5-notebooks.html">Notebooks</a>

                </nav>
              <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/index.html">OpenCL</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/1-autotune.html">Autotune</a>
              <a class="nav-link active disabled" href="../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/2-bulktune.html">Parameters</a>

                </nav>

                </nav>

                </nav>
              <a class="nav-link" href="../../../../../page/3-developer-guide/4-performance/index.html">Performance</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../../../page/3-developer-guide/4-performance/1-insights.html">Insights</a>
              <a class="nav-link" href="../../../../../page/3-developer-guide/4-performance/2-just-in-time-compilation.html">JIT</a>

                </nav>

                </nav>
          </nav>
        </div>
      </div>

    <div class="col-9" id='text'>
      <h1>Optimized Kernels</h1>
<p>Optimized kernel parameters are stored in JSON-files and are automatically summarized into a CSV-file. Further and beyond auto-tuning kernels, <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/opencl/smm/tune_multiply.py">tune_multiply.py</a> can be used to perform basic operations on collected data: explicitly merging all JSON-files into a CSV-file (<code>tune_multiply.py -m</code>), and updating the device name in all JSON-files according to current driver version (<code>tune_multiply.py -u</code>).</p>
<p>Collected or auto-tuned parameters achieved with single precision (SP), double precision (DP), or from different devices can be safely combined. Practically, <code>acc_opencl.sh</code> transforms the CSV-file into source code compiled into the final binary, which is independent of <code>OPENCL_LIBSMM_SMM_PARAMS</code> accepting a CSV-file (path/filename). However, <code>acc_opencl.sh</code> currently limits the origin of parameters to a single device. Care must still be taken to not summarize unrelated results, e.g., after (major) source code changes. The CSV-file is automatically incorporated into LIBSMM by the next clean (re-)build. The format of the CSV-file is assumed to contain column names in the first row (header).</p>
<p>Different problem sizes (like "s15"; see above) are not represented individually, but are instead collected into a maximum value. In turn, this means tuning for a non-default problem-size must be manually kept pure since the result achieved with a larger problem may dominate (maximum value).</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc/opencl
make<span class="w"> </span>realclean
make
</code></pre></div>

<p>This way auto-tuned kernels just work and can be of course exercised using the afore mentioned benchmark:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc
./acc_bench_smm<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">30000</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">7</span>
</code></pre></div>

<p>Tuned parameters can be also disabled at runtime like:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc
<span class="nv">OPENCL_LIBSMM_SMM_PARAMS</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>./acc_bench_smm<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">30000</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">7</span>
</code></pre></div>

<p>By supplying a CSV-file at runtime, embedded parameters and defaults are overriden, and given parameters are applied even if the current device is different from what would match the given parameters:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc
<span class="nv">OPENCL_LIBSMM_SMM_PARAMS</span><span class="o">=</span>opencl/smm/tune_multiply.csv<span class="w"> </span>./acc_bench_smm<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">30000</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">7</span>
</code></pre></div>

<p>To tune multiple kernels in a convenient fashion, a triplet specification can be supplied to the <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/opencl/smm/tune_multiply.sh">tune_multiply.sh</a> wrapper script. This script estimates the total runtime for auto-tuning kernels, cleans up intermediate results (<code>opentuner.db</code>), allows to specify triplets, and splits work to auto-tune in parallel.</p>
<p>Triplets are used to conveniently describe multiple kernels. A triplet specification consists of comma-separated groups of (M,N,K)-extents, i.e., matrix shapes according to GEMM. For example:</p>
<div class="codehilite"><pre><span></span><code>4 10 15, 6 7 8, 23
</code></pre></div>

<p>This triplet specification expands to 55 kernels using the Cartesian product within each group and concatenating the result of such expanded groups followed by removing duplicate triplets. Further, the wrapper script allows to limit the time spent for tuning a single kernel and to partition the number of kernels to be tuned, e.g., among a cluster of eight systems (below the first partition out of eight would be processed with five minutes per kernel and about 35 minutes in total per partition).</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc/opencl/smm
./tune_multiply.sh<span class="w"> </span>-t<span class="w"> </span><span class="m">300</span><span class="w">  </span>-j<span class="w"> </span><span class="m">8</span><span class="w"> </span>-i<span class="w"> </span><span class="m">1</span><span class="w">  </span><span class="m">4</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">15</span>,<span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="m">7</span><span class="w"> </span><span class="m">8</span>,<span class="w"> </span><span class="m">23</span>
</code></pre></div>

<p>The script <code>tune_multiply.sh</code> is tuning 1266 kernels by default (<code>./tune_multiply.sh -t 300 -j 8 -i 1</code> takes approximately 13 hours per part). If the process is interrupted earlier (per SIGINT or Ctrl-C), the execution terminates for all requested kernels (triplet specification) unless <code>--continue</code> is given (or <code>-c</code>, or an environment variable <code>CONTINUE=1</code>).</p>
<p>For convenience, it is possible to "update" an existing set of JSON-files (path can be given with <code>-p</code>), i.e., to parse the (M,N,K)-triplet denoted by the JSON filename and to re-tune with an almost unconstrained tuning-level (<code>-a 1</code> by default) as well as a limited duration (160 seconds per kernel by default).</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc/opencl
make<span class="w"> </span>realclean
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Rebuild and embed smm/params/tune_multiply_P100.csv&quot;</span>
make<span class="w"> </span><span class="nv">WITH_GPU</span><span class="o">=</span>P100

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Retune original parameters&quot;</span>
smm/tune_multiply.sh<span class="w"> </span>-p<span class="w"> </span>smm/params/p100<span class="w"> </span>-u

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Override original parameters&quot;</span>
cp<span class="w"> </span>tune_multiply.csv<span class="w"> </span>smm/params/tune_multiply_P100.csv
</code></pre></div>

<p>Tuning kernels further is only sensible if the previously tuned parameters are embedded into the binary (such that the process does not start from scratch). Retuned parameters are captured with JSON-files as usual.</p>
<h1>Advanced Tuning</h1>
<p>To utilize multiple devices per system and to accelerate tuning kernels, <code>tune_multiply.py</code> comes with built-in support for running under MPI (SPMD execution model). The basic assumption is to spawn one process per device usually with different kernels tuned per device (SPMD). Of course, tuning the same kernels in parallel on multiple devices is possible but it is a waste of resources. Tuning on multiple devices per system can be also more realistic given the common power budget of all devices and less room for an increased operating frequency per device (Turbo clock speed).</p>
<p>For example, a single dual-socket system with two PVC cards (modules) per socket exposes eight GPU devices (two GPU stacks or tiles per card). Then 350 kernels can be tuned in less than 2 1/2 hours with a duration of 200 seconds for tuning each kernel.</p>
<div class="codehilite"><pre><span></span><code><span class="nv">MAXTIME</span><span class="o">=</span><span class="m">200</span><span class="w"> </span><span class="nv">NPARTS</span><span class="o">=</span><span class="m">8</span><span class="w"> </span><span class="nv">UPDATE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">JSONDIR</span><span class="o">=</span>params/pvc<span class="w"> </span>mpirun<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">1</span><span class="w"> </span>:<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">2</span><span class="w"> </span>:<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">3</span><span class="w"> </span>:<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">4</span><span class="w"> </span>:<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">5</span><span class="w"> </span>:<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">6</span><span class="w"> </span>:<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">7</span><span class="w"> </span>:<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tune_multiply.sh<span class="w"> </span>-i<span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="se">\</span>
&gt;out.log<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</code></pre></div>

<p><strong>NOTE</strong>: The above shown example prefers environment variables over command-line options that would be common to the eight launches of <code>tune_multiply.sh</code>.</p>
    </div>
  </div>
      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col"><p>DBCSR was developed by DBCSR Authors<br>&copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </body>
</html>