<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="">
    <meta name="author" content="DBCSR Authors" >
    <link rel="icon" href="../../../../../favicon.png">

    <title>OpenCL &ndash; DBCSR</title>

    <link href="../../../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../../../css/pygments.css" rel="stylesheet">
    <link href="../../../../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../../css/local.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

         <script src="../../../../../js/jquery-2.1.3.min.js"></script>
         <script src="../../../../../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../../../../index.html">DBCSR <small>2.6.0</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
              <li><a href='../../../../../page/index.html'>Guide</a></li>
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
                 data-toggle="dropdown" role="button"
                 aria-haspopup="true"
                 aria-expanded="false">
                 Contents <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                    <li><a href="../../../../../lists/files.html">Source Files</a></li>
                  <li><a href="../../../../../lists/modules.html">Modules</a></li>
                  <li><a href="../../../../../lists/procedures.html">Procedures</a></li>
                  <li><a href="../../../../../lists/absint.html">Abstract Interfaces</a></li>
                  <li><a href="../../../../../lists/types.html">Derived Types</a></li>
                  <li><a href="../../../../../lists/programs.html">Programs</a></li>
              </ul>
            </li>
                <li class="visible-xs hidden-sm visible-lg">
                  <a href="../../../../../lists/files.html">Source Files</a>
                </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/modules.html">Modules</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/procedures.html">Procedures</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/absint.html">Abstract Interfaces</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/types.html">Derived Types</a>
              </li>
              <li class="visible-xs hidden-sm visible-lg">
                <a href="../../../../../lists/programs.html">Programs</a>
              </li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
  <div class="row">
    <h1>OpenCL</h1>
    <div class="row">
    <div class="col-lg-12">
    <div class="well well-sm" style="min-height: 40px;">
      <ul class="list-inline" style="margin-bottom:0px; display:inline">
<!--
        <li><i class="fa fa-sitemap"></i> Subsections:</li>
        <li><a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/1-autotune.html'>Autotune</a></li>
        <li><a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/2-bulktune.html'>Parameters</a></li>
-->
      </ul>
        <ol class="breadcrumb in-well">
         <li><a href='../../../../../page/index.html'>Guide</a></li>
         <li><a href='../../../../../page/3-developer-guide/index.html'>Developer Guide</a></li>
         <li><a href='../../../../../page/3-developer-guide/3-programming/index.html'>Programming</a></li>
         <li><a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/index.html'>Accelerator Backend</a></li>
         <li class="active">OpenCL</li>
      </ol>
    </div>
    </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-9 col-md-push-3" id='text'>
      <h1>Backend</h1>
<p>The OpenCL backend implements the <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/acc.h">ACC interface</a>, which is exposed in Fortran and used throughout DBCSR's code base to drive (GPU-)acceleration based on ACC's device enumeration, data movement, and synchronization functionality. By design, DBCSR activates one device per rank (process). For instance, multiple GPUs can be used by the means of multiple ranks per system or at least one rank per device. The LIBSMM library complements the backend and implements the <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/acc_libsmm.h">ACC LIBSMM interface</a>.</p>
<p>All major GPU vendors support OpenCL even if the vendor-preferred programming model suggests otherwise. On Nvidia GPUs, the OpenCL backend can be used with CUDA based GPU-code in other portions of CP2K. The OpenCL based backend provides the following benefits:</p>
<ul>
<li>Code portability between GPU vendors (if not performance portability). For instance, performance of the OpenCL backend matches the performance of the CUDA backend or exceeds it.</li>
<li>Acceptable performance for kernels not covered by specifically tuned parameters, and the ability to run on GPU if no tuned parameters are present.</li>
<li>Auto-tuning kernels within an acceptable time limit along with handy scripts to retune parameters and to carry forward an existing set (new GPU).</li>
</ul>
<p>Runtime settings are made by the means of environment variables. The OpenCL backend provides <code>acc_getenv.sh</code> to list all occurrences of <code>getenv</code> categorized into "OpenCL Backend environment variables" and "OpenCL LIBSMM environment variables". Common backend related settings are:</p>
<ul>
<li><code>ACC_OPENCL_DEVSPLIT</code>: integer enabling devices to be split into subdevices (non-zero/default: subdevices, zero: aggregated).</li>
<li><code>ACC_OPENCL_DEVTYPE</code>: character string selecting "cpu", "gpu", "all" (unfiltered), or any other string (neither CPU or GPU).</li>
<li><code>ACC_OPENCL_DEVICE</code>: non-negative integer number to select a device from the (internally enumerated) list of devices.</li>
<li><code>ACC_OPENCL_VENDOR</code>: character string matching the vendor of the OpenCL device in a case-insensitive fashion, e.g., "intel".</li>
<li><code>ACC_OPENCL_VERBOSE</code>: verbosity level (integer) with console output on <code>stderr</code>.<ul>
<li><code>ACC_OPENCL_VERBOSE=1</code>: outputs the number of devices found and the name of the selected device.</li>
<li><code>ACC_OPENCL_VERBOSE=2</code>: outputs the duration needed to generate a requested kernel.</li>
<li><code>ACC_OPENCL_VERBOSE=3</code>: outputs device-side performance of kernels (every launch profiled).</li>
</ul>
</li>
<li><code>ACC_OPENCL_DUMP</code>: dump preprocessed kernel source code (1) or dump compiled OpenCL kernels (2).<ul>
<li><code>ACC_OPENCL_DUMP=1</code>: dump preprocessed kernel source code and use it for JIT compilation. Instantiates the original source code using preprocessor definitions (<code>-D</code>) and collapses the code accordingly.</li>
<li><code>ACC_OPENCL_DUMP=2</code>: dump compiled OpenCL kernels (depends on OpenCL implementation), e.g., PTX code on Nvidia.</li>
</ul>
</li>
</ul>
<p>The OpenCL backend enumerates and orders devices by kind, i.e., GPU, CPU, and "other" (primary criterion) and by memory capacity (secondary criterion). Device IDs are zero-based as defined by the ACC interface (and less than what is permitted by <code>acc_get_ndevices</code>).</p>
<h1>LIBSMM</h1>
<p>The LIBSMM library implements the <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/acc_libsmm.h">ACC LIBSMM interface</a>, and depends on the <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/opencl/README.md">OpenCL backend</a>.</p>
<p>Compile-time settings are (implicitly) documented and can be adjusted by editing <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/opencl/smm/opencl_libsmm.h">opencl_libsmm.h</a>, e.g., <code>OPENCL_LIBSMM_VALIDATE</code> is disabled by default but can be enabled for debug purpose. The <code>OPENCL_LIBSMM_VALIDATE</code> compile-time setting enables side-by-side validation of matrix transpose and multiply operations between device and host. For example, running DBCSR's unit tests with <code>OPENCL_LIBSMM_VALIDATE</code> enabled produces console output that allows to pin-point a kernel which misses validation. Runtime settings are made by the means of environment variables. The OpenCL backend provides <code>acc_getenv.sh</code> to list all occurrences of <code>getenv</code> categorized into "OpenCL Backend environment variables" and "OpenCL LIBSMM environment variables".</p>
<p>There are two categories for the two domains in LIBSMM, i.e., matrix transpose (<code>OPENCL_LIBSMM_TRANS_*</code>) and matrix multiplication (<code>OPENCL_LIBSMM_SMM_*</code>). For transposing matrices, the settings are:</p>
<ul>
<li><code>OPENCL_LIBSMM_TRANS_BUILDOPTS</code>: character string with build options (compile and link) supplied to the OpenCL runtime compiler.</li>
<li><code>OPENCL_LIBSMM_TRANS_INPLACE</code>: Boolean value (zero or non-zero integer) for in-place matrix transpose (no local memory needed).</li>
<li><code>OPENCL_LIBSMM_TRANS_BM</code>: non-negative integer number (less/equal than the M-extent) denoting the blocksize in M-direction.</li>
</ul>
<p>The most common settings for multiplying matrices are:</p>
<ul>
<li><code>OPENCL_LIBSMM_SMM_BUILDOPTS</code>: character string with build options (compile and link) supplied to the OpenCL runtime compiler.</li>
<li><code>OPENCL_LIBSMM_SMM_ATOMICS</code>: selects the kind of atomic operation used for global memory updates (<code>xchg</code>, <code>cmpxchg</code>, <code>cmpxchg2</code>), attempts to force atomic instructions, or disables atomic instructions (<code>0</code>). The latter is for instance to quantify the impact of atomic operations.</li>
<li><code>OPENCL_LIBSMM_SMM_PARAMS</code>: Disable embedded/auto-tuned parameters (<code>0</code>), or load CSV-file (e.g., <code>path/to/tune_multiply.csv</code>).</li>
<li><code>OPENCL_LIBSMM_SMM_BS</code>: non-negative integer number denoting the intra-kernel (mini-)batchsize mainly used to amortize atomic updates of data in global/main memory. The remainder with respect to the "stacksize" is handled by the kernel.</li>
<li><code>OPENCL_LIBSMM_SMM_BM</code>: non-negative integer number (less/equal than the M-extent) denoting the blocksize in M-direction.</li>
<li><code>OPENCL_LIBSMM_SMM_BN</code>: non-negative integer number (less/equal than the N-extent) denoting the blocksize in N-direction.</li>
<li><code>OPENCL_LIBSMM_SMM_AP</code>: specifies access to array of parameters (batch or "stack").</li>
<li><code>OPENCL_LIBSMM_SMM_AA</code>: specifies access to array of A-matrices.</li>
<li><code>OPENCL_LIBSMM_SMM_AB</code>: specifies access to array of B-matrices.</li>
<li><code>OPENCL_LIBSMM_SMM_AC</code>: specifies access to array of C-matrices.</li>
</ul>
<p>The full list of tunable parameters and some explanation can be received with <code>smm/tune_multiply.py --help</code>, i.e., short description, default settings, and accepted values.</p>
<p><strong>NOTE</strong>: LIBSMM's tunable runtime settings can be non-smooth like producing distinct code-paths, e.g., <code>OPENCL_LIBSMM_SMM_BS=1</code> vs. <code>OPENCL_LIBSMM_SMM_BS=2</code>.</p>
<h1>Auto Tuning</h1>
<p>To tune and optimize a kernel and generating kernel parameters, please refer to the <a href="https://cp2k.github.io/dbcsr/develop/page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/1-autotune.html">Auto Tuning</a> guide. To update or retune an entire set of kernels (optimized parameters), please refer to the <a href="https://cp2k.github.io/dbcsr/develop/page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/2-bulktune.html">Bulk Tuning</a> guide.</p>
    </div>
    <div class="col-md-3 col-md-pull-9">
      <hr class="visible-xs visible-sm">
        <div class="well toc">
          <ul class="nav nav-stacked nav-pills">
            <li role="presentation" class="title"><a href='../../../../../page/index.html'>Guide</a></li>
          </ul>
          <hr>
          <ul class="nav nav-stacked nav-pills">
            <li role="presentation">
            <a href='../../../../../page/1-DBCSR/index.html'>DBCSR</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/1-DBCSR/publications.html'>Publications</a>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/index.html'>User Guide</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/index.html'>Install</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/1-cmake-build-recipes.html'>CMake Build Recipes</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/2-supported-compilers.html'>Supported Compilers</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/3-using-dbcsr-in-a-cmake-project.html'>Using DBCSR in a CMake project</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/1-installation/4-docker.html'>Docker Images</a>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/2-tests/index.html'>Tests</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/3-examples/index.html'>Examples</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/2-user-guide/4-gpu/index.html'>GPUs</a>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/index.html'>Developer Guide</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/1-tooling/index.html'>Tooling</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/2-documentation/index.html'>Documentation</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/index.html'>Programming</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/1-overview/index.html'>Overview</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/index.html'>Accelerator Backend</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/1-code-structure.html'>Code Structure</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/index.html'>CUDA/HIP</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/1-kernels.html'>Kernels</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/2-parameters.html'>Kernel Parameters</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/3-tune.html'>Autotuning Framework</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/4-predict.html'>Predictive Modeling Framework</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/5-notebooks.html'>Notebooks</a>
            </li>

            </ul>
            </li>
            <li role="presentation" class="disabled">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/index.html'>OpenCL</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/1-autotune.html'>Autotune</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/2-bulktune.html'>Parameters</a>
            </li>

            </ul>
            </li>

            </ul>
            </li>

            </ul>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/4-performance/index.html'>Performance</a>
            <ul class="nav nav-stacked nav-pills">
                          <li role="presentation">
            <a href='../../../../../page/3-developer-guide/4-performance/1-insights.html'>Insights</a>
            </li>
            <li role="presentation">
            <a href='../../../../../page/3-developer-guide/4-performance/2-just-in-time-compilation.html'>JIT</a>
            </li>

            </ul>
            </li>

            </ul>
            </li>
          </ul>
        </div>
    </div>
  </div>
      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-xs-6 col-md-6"><p>DBCSR was developed by DBCSR Authors<br>&copy; 2023 
</p>
          </div>
          <div class="col-xs-6 col-md-6">
            <p class="text-right">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript
         ================================================== -->
         <!-- Placed at the end of the document so the pages load faster -->
    <!--
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        -->
        <script src="../../../../../js/bootstrap.min.js"></script>
        <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
        <script src="../../../../../js/ie10-viewport-bug-workaround.js"></script>

        <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </body>
</html>