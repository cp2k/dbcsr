<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="">
    <meta name="author" content="DBCSR Authors" >
    <link rel="icon" href="../../../../favicon.png">

    <title>Accelerator Backend &ndash; DBCSR</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../../../../css/pygments.css" rel="stylesheet">
    <link href="../../../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../../css/local.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../../../../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../../../../index.html">DBCSR <small>2.6.0</small></a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../../../index.html">Guide</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../lists/types.html">Derived Types</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../../lists/programs.html">Programs</a>
                </li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>Accelerator Backend</h1>
    <div class="container p-2 mb-4 bg-light border rounded-3">
      <div class="row align-items-center justify-content-between">
        <div class="col">
          <ul class="list-inline" style="margin-bottom:0px; display:inline">
          </ul>
        </div>
        <div class="col">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../../../index.html'>Guide</a></li>
                <li class="breadcrumb-item"><a href='../../index.html'>Developer Guide</a></li>
                <li class="breadcrumb-item"><a href='../index.html'>Programming</a></li>
              <li class="breadcrumb-item active" aria-current="page">Accelerator Backend</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
      <div class="col-3">
        <div class="card card-body bg-light" id="sidebar-toc">
          <ul class="nav flex-column align-items">
            <li class="nav-item">
              <a class="nav-link" href="../../../index.html">Guide</a>
            </li>
          </ul>
          <hr>
          <nav class="nav nav-pills flex-column">
              <a class="nav-link" href="../../../1-DBCSR/index.html">DBCSR</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../1-DBCSR/publications.html">Publications</a>

                </nav>
              <a class="nav-link" href="../../../2-user-guide/index.html">User Guide</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../2-user-guide/1-installation/index.html">Install</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../../2-user-guide/1-installation/1-cmake-build-recipes.html">CMake Build Recipes</a>
              <a class="nav-link" href="../../../2-user-guide/1-installation/2-supported-compilers.html">Supported Compilers</a>
              <a class="nav-link" href="../../../2-user-guide/1-installation/3-using-dbcsr-in-a-cmake-project.html">Using DBCSR in a CMake project</a>
              <a class="nav-link" href="../../../2-user-guide/1-installation/4-docker.html">Docker Images</a>

                </nav>
              <a class="nav-link" href="../../../2-user-guide/2-tests/index.html">Tests</a>
              <a class="nav-link" href="../../../2-user-guide/3-examples/index.html">Examples</a>
              <a class="nav-link" href="../../../2-user-guide/4-gpu/index.html">GPUs</a>

                </nav>
              <a class="nav-link" href="../../index.html">Developer Guide</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../1-tooling/index.html">Tooling</a>
              <a class="nav-link" href="../../2-documentation/index.html">Documentation</a>
              <a class="nav-link" href="../index.html">Programming</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../1-overview/index.html">Overview</a>
              <a class="nav-link active disabled" href="index.html">Accelerator Backend</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="1-code-structure.html">Code Structure</a>
              <a class="nav-link" href="2-libsmm_acc/index.html">CUDA/HIP</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="2-libsmm_acc/1-kernels.html">Kernels</a>
              <a class="nav-link" href="2-libsmm_acc/2-parameters.html">Kernel Parameters</a>
              <a class="nav-link" href="2-libsmm_acc/3-tune.html">Autotuning Framework</a>
              <a class="nav-link" href="2-libsmm_acc/4-predict.html">Predictive Modeling Framework</a>
              <a class="nav-link" href="2-libsmm_acc/5-notebooks.html">Notebooks</a>

                </nav>
              <a class="nav-link" href="3-libsmm_ocl/index.html">OpenCL</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="3-libsmm_ocl/1-autotune.html">Autotune</a>
              <a class="nav-link" href="3-libsmm_ocl/2-bulktune.html">Parameters</a>

                </nav>

                </nav>

                </nav>
              <a class="nav-link" href="../../4-performance/index.html">Performance</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../4-performance/1-insights.html">Insights</a>
              <a class="nav-link" href="../../4-performance/2-just-in-time-compilation.html">JIT</a>

                </nav>

                </nav>
          </nav>
        </div>
      </div>

    <div class="col-9" id='text'>
      <h1>ACCelerator Interface</h1>
<h2>Backends</h2>
<p>The accelerator interface (ACC) consists of ISO_C_BINDING based Fortran code of DBCSR's <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/acc.h">ACC-backend interface</a> and <a href="https://github.com/cp2k/dbcsr/blob/develop/src/acc/acc_libsmm.h">LIBSMM/ACC-interface</a>. The interface is implemented by CUDA (for Nvidia GPUs), the HIP (for AMD GPUs), and the OpenCL accelerator backends.</p>
<p>The code for both the CUDA and the HIP backend is unified, and can be found in the <code>cuda</code> directory. At compile-time either one or the other backend is chosen per macro (<code>__CUDA</code> or <code>__HIP</code>). Similarly, the code for the OpenCL backend is activated by a build-time macro (<code>__OPENCL</code>).</p>
<h2>Drivers</h2>
<p>There are two stand-alone sample codes or drivers exercising the ACC-interface. The driver code (only depending on above mentioned interfaces) can be built locally and in a rather self-contained fashion, i.e., no DBCSR library is needed (except runtime libraries such as CUDA, HIP, OpenCL). For OpenCL, the LIBXSMM library is mandatory and preferred as baseline and for validation in any case. To build LIBXSMM, a folder <code>libxsmm</code> in parallel to DBCSR's root directory (<code>dbcsr</code>) is expected to be present and prebuilt.</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>main<span class="w"> </span>https://github.com/libxsmm/libxsmm.git
<span class="nb">cd</span><span class="w"> </span>libxsmm
make<span class="w"> </span><span class="nv">GNU</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>-j
</code></pre></div>

<p>To build the driver code (<code>opencl</code> in below example), change into the respective backend folder (<code>cuda</code> or <code>opencl</code>), and invoke <code>make</code> (<code>DBG=0|1|2</code> is supported among other optional key-value pairs).</p>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/cp2k/dbcsr.git
<span class="nb">cd</span><span class="w"> </span>dbcsr/src/acc/opencl
make
</code></pre></div>

<p><strong>NOTE</strong>: To activate a certain device, the drivers consider an environment variable called <code>DEVICE</code>. For example, <code>DEVICE=1 ./acc_bench_trans</code> activates the second device (at least two devices must be discovered). This environment variable is implemented by the driver code and meant to work across backends, i.e., the OpenCL backend also supports <code>ACC_OPENCL_DEVICE=1</code> (see Developer Guide for the OpenCL backend).</p>
<p>The drivers support command line options (<em>nrepeat</em>, <em>stack_size</em>, <em>m</em>, <em>n</em>, ...). Command line arguments are positional but allow <code>0</code> as placeholder to refer to the default value (<code>acc_bench_smm 0 0 5 13 5</code> performs the default number of repetitions with the default stacksize when running the 5x13x5-kernel). For example, running the tranpose benchmark may look like:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span><span class="nv">OMP_PROC_BIND</span><span class="o">=</span>TRUE<span class="w"> </span>./acc_bench_trans<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">30000</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="m">23</span>
./acc_bench_trans<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="m">30000</span><span class="w"> </span><span class="m">23</span><span class="w"> </span><span class="m">23</span>
typename<span class="w"> </span><span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="m">3</span><span class="o">)</span>:<span class="w"> </span>double
copy-in:<span class="w"> </span><span class="m">17</span>.2<span class="w"> </span>ms<span class="w"> </span><span class="m">7</span>.2<span class="w"> </span>GB/s
device:<span class="w"> </span><span class="m">8</span>.7<span class="w"> </span>ms<span class="w"> </span><span class="m">14</span>.2<span class="w"> </span>GB/s
host:<span class="w"> </span><span class="m">8</span>.4<span class="w"> </span>ms<span class="w"> </span><span class="m">14</span>.6<span class="w"> </span>GB/s
errors:<span class="w"> </span><span class="m">0</span>
</code></pre></div>

<p>For timing, comparison (host code), and validation, LIBXSMM is required. The drivers exercise the respective backend. For example with the CUDA backend:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc/cuda
make<span class="w"> </span><span class="nv">WITH_GPU</span><span class="o">=</span>P100
../acc_bench_smm
</code></pre></div>

<p>For the OpenCL backend:</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>src/acc/opencl
make
../acc_bench_smm
</code></pre></div>

<p>In above cases, <code>acc_bench_trans</code> and <code>acc_bench_smm</code> are built using the respective backend. Both driver codes can be built for double-precision (default) or single-precision using a build-time macro (<code>make ELEM_TYPE=float</code> or <code>-DELEM_TYPE=float</code> in general).</p>
    </div>
  </div>
      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col"><p>DBCSR was developed by DBCSR Authors<br>&copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </body>
</html>