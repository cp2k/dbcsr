<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="">
    <meta name="author" content="DBCSR Authors" >
    <link rel="icon" href="../../../favicon.png">

    <title>GPUs &ndash; DBCSR</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../../../css/pygments.css" rel="stylesheet">
    <link href="../../../css/font-awesome.min.css" rel="stylesheet">
    <link href="../../../css/local.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../../../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../../../index.html">DBCSR <small>2.7.0-rc1</small></a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../../index.html">Guide</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/types.html">Derived Types</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../../../lists/programs.html">Programs</a>
                </li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>GPUs</h1>
    <div class="container p-2 mb-4 bg-light border rounded-3">
      <div class="row align-items-center justify-content-between">
        <div class="col">
          <ul class="list-inline" style="margin-bottom:0px; display:inline">
          </ul>
        </div>
        <div class="col">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../../index.html'>Guide</a></li>
                <li class="breadcrumb-item"><a href='../index.html'>User Guide</a></li>
              <li class="breadcrumb-item active" aria-current="page">GPUs</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
      <div class="col-3">
        <div class="card card-body bg-light" id="sidebar-toc">
          <ul class="nav flex-column align-items">
            <li class="nav-item">
              <a class="nav-link" href="../../index.html">Guide</a>
            </li>
          </ul>
          <hr>
          <nav class="nav nav-pills flex-column">
              <a class="nav-link" href="../../1-DBCSR/index.html">DBCSR</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../1-DBCSR/publications.html">Publications</a>

                </nav>
              <a class="nav-link" href="../index.html">User Guide</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../1-installation/index.html">Install</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../1-installation/1-cmake-build-recipes.html">CMake Build Recipes</a>
              <a class="nav-link" href="../1-installation/2-supported-compilers.html">Supported Compilers</a>
              <a class="nav-link" href="../1-installation/3-using-dbcsr-in-a-cmake-project.html">Using DBCSR in a CMake project</a>
              <a class="nav-link" href="../1-installation/4-docker.html">Docker Images</a>

                </nav>
              <a class="nav-link" href="../2-tests/index.html">Tests</a>
              <a class="nav-link" href="../3-examples/index.html">Examples</a>
              <a class="nav-link active disabled" href="index.html">GPUs</a>

                </nav>
              <a class="nav-link" href="../../3-developer-guide/index.html">Developer Guide</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../3-developer-guide/1-tooling/index.html">Tooling</a>
              <a class="nav-link" href="../../3-developer-guide/2-documentation/index.html">Documentation</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/index.html">Programming</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../3-developer-guide/3-programming/1-overview/index.html">Overview</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/index.html">Accelerator Backend</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/1-code-structure.html">Code Structure</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/index.html">CUDA/HIP</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/1-kernels.html">Kernels</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/2-parameters.html">Kernel Parameters</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/3-tune.html">Autotuning Framework</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/4-predict.html">Predictive Modeling Framework</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/5-notebooks.html">Notebooks</a>

                </nav>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/index.html">OpenCL</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/1-autotune.html">Autotune</a>
              <a class="nav-link" href="../../3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/2-bulktune.html">Parameters</a>

                </nav>

                </nav>

                </nav>
              <a class="nav-link" href="../../3-developer-guide/4-performance/index.html">Performance</a>
                <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="../../3-developer-guide/4-performance/1-insights.html">Insights</a>
              <a class="nav-link" href="../../3-developer-guide/4-performance/2-just-in-time-compilation.html">JIT</a>

                </nav>

                </nav>
          </nav>
        </div>
      </div>

    <div class="col-9" id='text'>
      <h1>Introduction</h1>
<p><a href="https://github.com/cp2k/cp2k/">CP2K</a> was initially enabled for GPUs by the means of the DBCSR library. The original development focused on scalability and an assumption of a <code>1:1</code>-relationship between CPUs and GPUs (one CPU-socket drives one GPU). Multi-GPU asks for associating CPU-ranks with the closest GPU (affinity), but is usually a desparture in terms of algorithms as well (GPU to GPU communication). DBCSR associates ranks with GPUs based on a round-robin scheme using the rank-ID, i.e., GPU-affinity is only achieved with the help of the underlying MPI implementation or support from other runtimes. Aggregating GPU acceleration in as little as possible systems is contrary to the original design of DBCSR (and CP2K at that time). CP2K is a versatile toolbox covering a variety of workloads (input language), which imposes several hotspots beyond DBCSR (<a href="https://www.cp2k.org/gpu">status</a>).</p>
<p>CP2K or DBCSR can scale to thousands of nodes and furter benefit from thread-scalability once communication starts to dominate (due to higher total rank-counts). Thread-scalability (OpenMP) in DBCSR if not CP2K is not equally developed when compared to process scalability (MPI), i.e., higher rank-counts tend to yield better performance on smaller number of systems or nodes. With multiple ranks per GPU, context switches and other overhead can negatively impact performance. However, more ranks are needed to best drive the CPU-dominated portion of the code, and hence GPU and in particular multi-GPU acceleration poses a challenge.</p>
<p>CP2K almost exclusively uses double-precision calculations on CPUs and GPUs (along with DBCSR's need for atomic update instructions for GPUs). Consumer focused GPU offerings often deliver a FLOP-rate ratio between single and double precision up to <code>SP:DP = 64:1</code>, which renders them unsuitable for CP2K like not beneficial when compared to modestly many CPU cores. Further, GPU accleration hinges on memory bandwidth rather than compute which further limits the benefit.</p>
<h1>CUDA/HIP Backend</h1>
<p>Users interested to tune kernels for the CUDA/HIP backend and LIBSMM_ACC, can take a look at the <a href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/3-tune.html">Developer Guide</a>. Following the guide, <a href="https://github.com/cp2k/dbcsr/tree/develop/src/acc/libsmm_acc/parameters">tuned parameters</a> can be collected for the desired GPU and potentially submitted for the benefit of others.</p>
<h1>OpenCL Backend</h1>
<p>This section shows how to auto-tune a kernel for the OpenCL based LIBSMM library. The process builds a stand-alone driver program which is then driven by an <a href="https://opentuner.org/">OpenTuner</a> based script guiding the auto-tuning of the desired kernel. The <a href="../../3-developer-guide/3-programming/2-accelerator-backend/3-libsmm_ocl/1-autotune.html">Developer Guide</a> provides more information, e.g., about constraining execution time or parallelizing the tuning-process as well as how to select and tune an entire set of kernels.</p>
<p>For simplicity, the GNU Compiler is used to build the afore mentioned driver program, both DBCSR and LIBXSMM are Git-cloned into the same common directory, e.g., the user's <code>HOME</code> directory, and the driver is built for tuning double-precision kernels (DP).</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/hfp/libxsmm.git
<span class="nb">cd</span><span class="w"> </span>libxsmm
make<span class="w"> </span><span class="nv">GNU</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>-j

<span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/cp2k/dbcsr.git
<span class="nb">cd</span><span class="w"> </span>dbcsr/src/acc/opencl
make
</code></pre></div>

<p>Tuning the 23x23x23-kernel for example is the default case. However, to better illustrate the options, M, N, and K are given explicitly. The <code>tune_multiply.py</code> script can be used interactively for example, and terminated with CTRL-C which writes a JSON-file with tuned parameters (note a file <code>.tune_multiply-double-32x32x32.json</code> is quietly written every time a better set of parameters is found), and then aggregates all JSON-files in the directory into a CSV-file (<code>tune_multiply.csv</code>).</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/dbcsr/src/acc/opencl/smm
./tune_multiply.py<span class="w"> </span>23x23x23
</code></pre></div>

<p>Beside of interactive termination, above process would also terminate based on OpenTuner's default or can be constrained by the number of steps (experiments), time to be spent, or a combination of both. Details can be found in the <a href="../../3-developer-guide/3-programming/2-accelerator-backend/2-libsmm_acc/3-tune.html">Developer Guide</a>.</p>
<p>Suppose the 23x23x23-kernel was tuned for some time (e.g., 5-10 minutes), tuned parameters can be incorporated into the backend. The aggregated parameters (<code>tune_multiply.csv</code>) are automatically embedded when rebuilding the library and driver.</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/dbcsr/src/acc/opencl
make
</code></pre></div>

<p>Important kernels can be further tuned (in addition to spending more time for the process) by widening the set of tuned parameters (<code>--tuning-level</code> or <code>-a</code> with "0" denoting an unrestricted set of tunables).</p>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span>/dbcsr/src/acc/opencl/smm
./tune_multiply.py<span class="w"> </span>23x23x23<span class="w"> </span>-a<span class="w"> </span><span class="m">0</span>
</code></pre></div>

<p>To "continue" tuning beyond the default level, the previously found parameters must be embedded (by rebuilding the library and driver program) or can be alternatively specified at runtime (<code>OPENCL_LIBSMM_SMM_PARAMS=/path/to/tune_multiply.csv</code>).</p>
    </div>
  </div>
      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col"><p>DBCSR was developed by DBCSR Authors<br>&copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </body>
</html>